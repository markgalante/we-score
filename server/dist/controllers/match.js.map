{"version":3,"file":"match.js","sourceRoot":"/src/","sources":["controllers/match.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  Request,\n  Response,\n} from 'express';\nimport type {\n  Document,\n  Types,\n} from 'mongoose';\n\nimport {\n  League as LeagueModel,\n  Match as MatchModel,\n  Team as TeamModel,\n} from '../models'\n\nimport * as ModelTypes from '../types';\n\n/**\n  homeTeam: Team, \n  homeScore: number, \n  awayTeam: Team, \n  awayScore: number, \n  league: League;\n)\n */\n\ntype MatchDataType = \n  Document<\n    unknown, any, ModelTypes.MatchSchema> & ModelTypes.MatchSchema & {\n    _id: Types.ObjectId;\n  }\n\ntype TeamDataType = \n  (\n    Document<\n      unknown,\n      any,\n      ModelTypes.TeamSchema\n    > & ModelTypes.TeamSchema & Required<{\n      _id: Types.ObjectId;\n    }>\n  ) | null\n\n\n\nexport const registerMatch = async (\n  req: Request,\n  res: Response,\n) => {\n  //Create Match with scores\n  try {\n    const match = await MatchModel.create({\n      ...req.body\n    });\n    await addMatchToLeague(req, res, match);\n    await updateTeams(req, match);\n    res\n    .status(201)\n    .send({\n      message: \"You have successfully registered a match\",\n      data: match,\n    })\n  } catch (error) {\n    res\n    .status(422)\n    .send({\n      message: \"Failure to register match\",\n      error,\n    })\n  }\n}\n\nconst addMatchToLeague = async (\n  req: Request,\n  res: Response,\n  data: MatchDataType,\n) => {\n  try {\n    await LeagueModel\n    .updateOne({\n      _id: req.body.league\n    }, {\n      $push: {\n        matches: data\n      }\n    });\n  } catch (error) {\n    res\n    .status(422)\n    .send({\n      message: \"Failure to add match to the league\",\n      error,\n    })\n  }\n}\n\n/**\n  homeTeam: Team, \n  homeScore: number, \n  awayTeam: Team, \n  awayScore: number, \n  league: League;\n)\n */\n\nconst updateTeams = async (\n  req: Request,\n  data: MatchDataType,\n) => {\n  try {\n    const homeTeam = await TeamModel.findById(data.homeTeam._id);\n    const awayTeam = await TeamModel.findById(data.awayTeam._id);\n    const league = await LeagueModel.findById(data.league._id);\n    const {\n      pointsDraw,\n      pointsLoss,\n      pointsWin,\n    } = league!;\n  \n    const {homeScore, awayScore} = req.body;\n    if (homeScore > awayScore) {\n      await updateTeamsStandings(\n        homeTeam, awayTeam, homeScore, awayScore, pointsWin, pointsLoss\n      );\n    }\n    if (homeScore < awayScore) {\n      await updateTeamsStandings(\n        homeTeam, awayTeam, homeScore, awayScore, pointsLoss, pointsWin,\n      )\n    }\n    if (homeScore === awayScore) {\n      await updateTeamsStandings(\n        homeTeam, awayTeam, homeScore, awayScore, pointsDraw, pointsDraw\n      )\n    }\n    console.debug('Successfully updated team standings')\n  } catch (error) {\n    console.error('Something went wrong updating team standings!');\n  }\n};\n\nconst updateTeamsStandings = async (\n  homeTeam: TeamDataType,\n  awayTeam: TeamDataType,\n  homeScore: number,\n  awayScore: number,\n  homePoints: number,\n  awayPoints: number,\n) => {\n  if(homeTeam){\n    homeTeam.goalsFor += homeScore;\n    homeTeam.goalsAgainst += awayScore;\n    homeTeam.points += homePoints;\n    await homeTeam.save();\n  }\n  if(awayTeam){\n    awayTeam.goalsFor += awayScore;\n    awayTeam.goalsAgainst += homeScore;\n    awayTeam.points += awayPoints;\n    await awayTeam.save();\n  }\n}"]}